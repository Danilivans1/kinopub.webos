{"version":3,"sources":["components/text/text.tsx","hooks/useApi.ts","components/button/button.tsx","views/speed/speed.tsx"],"names":["Text","styled","BodyText","useApi","method","params","options","client","useMemo","ApiClient","query","useQuery","Wrapper","div","StyledButton","EnactButton","ButtonInner","Icon","props","iconOnly","Button","icon","children","autoFocus","wrapperRef","useRef","useEffect","frameId","requestAnimationFrame","current","querySelector","focus","cancelAnimationFrame","ref","name","Locations","Location","Actions","updateSpeedReducer","state","action","type","payload","SpeedView","data","useReducer","speed","setSpeed","useState","started","setStarted","servers","map","items","location","server","dlURL","ulURL","pingURL","getIpURL","workers","worker","window","_settings","test_order","xhr_dlMultistream","setSelectedServer","onupdate","testState","dlStatus","currentWorkerIndex","setCurrentWorkerIndex","handleStart","useCallback","handleStop","onend","_state","start","abort","script","document","createElement","src","async","head","appendChild","removeChild","id","onClick"],"mappings":"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","file":"static/js/28.a24d0712.chunk.js","sourcesContent":["import BodyText from '@enact/moonstone/BodyText';\nimport styled from 'styled-components';\n\nconst Text = styled(BodyText)``;\n\nexport default Text;\n","import { useMemo } from 'react';\nimport { UseQueryOptions, useQuery } from 'react-query';\n\nimport ApiClient from 'api';\n\ntype Unpromise<T> = T extends Promise<infer U> ? U : T;\n\nexport type Methods = {\n  [method in keyof ApiClient]: ApiClient[method] extends Function ? Unpromise<ReturnType<ApiClient[method]>> : never;\n};\n\nexport type Method = keyof ApiClient & string;\n\nfunction useApi<T extends Method>(\n  method: T,\n  params: Parameters<ApiClient[T]> = [] as Parameters<ApiClient[T]>,\n  options?: UseQueryOptions<Methods[T]>,\n) {\n  const client = useMemo(() => new ApiClient(), []);\n  const query = useQuery<Methods[T]>(\n    [method, ...params],\n    () =>\n      // @ts-expect-error\n      client[method](...params) as Methods[T],\n    options,\n  );\n\n  return query;\n}\n\nexport default useApi;\n","import { useEffect, useRef } from 'react';\nimport EnactButton, { ButtonProps } from '@enact/moonstone/Button';\nimport styled from 'styled-components';\n\nimport Icon from 'components/icon';\n\nconst Wrapper = styled.div`\n  display: inline-flex;\n\n  > div {\n    width: 100%;\n  }\n`;\n\nconst StyledButton = styled(EnactButton)`\n  color: inherit;\n  text-decoration: none;\n`;\n\nconst ButtonInner = styled.div<{ iconOnly?: boolean }>`\n  display: flex;\n  align-items: center;\n  color: inherit;\n  text-decoration: none;\n\n  ${Icon} {\n    margin-right: ${(props) => !props.iconOnly && '0.5rem'};\n  }\n`;\n\ntype Props = {\n  icon?: string;\n  iconOnly?: boolean;\n  autoFocus?: boolean;\n  onClick?: React.MouseEventHandler;\n} & ButtonProps;\n\nconst Button: React.FC<Props> = ({ icon, iconOnly, children, autoFocus, ...props }) => {\n  const wrapperRef = useRef<HTMLDivElement | null>(null);\n\n  useEffect(() => {\n    let frameId: number;\n\n    if (autoFocus) {\n      frameId = requestAnimationFrame(() => {\n        wrapperRef.current?.querySelector<HTMLDivElement>('[role=\"button\"]')?.focus();\n      });\n    }\n\n    return () => {\n      if (frameId) {\n        cancelAnimationFrame(frameId);\n      }\n    };\n  }, [wrapperRef, autoFocus]);\n\n  return (\n    <Wrapper ref={wrapperRef}>\n      <StyledButton {...props}>\n        <ButtonInner iconOnly={iconOnly}>\n          {icon && <Icon name={icon} />}\n          {!iconOnly && children}\n        </ButtonInner>\n      </StyledButton>\n    </Wrapper>\n  );\n};\n\nexport default Button;\n","import React, { useCallback, useEffect, useMemo, useReducer, useState } from 'react';\nimport map from 'lodash/map';\nimport styled from 'styled-components';\n\nimport Button from 'components/button';\nimport Text from 'components/text';\nimport useApi from 'hooks/useApi';\n\nconst Locations = styled.div`\n  display: flex;\n  justify-content: space-around;\n`;\n\nconst Location = styled.div`\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n`;\n\nconst Actions = styled.div`\n  padding-top: 3rem;\n  display: flex;\n  justify-content: center;\n`;\n\nfunction updateSpeedReducer(state: { [location: string]: string }, action: { type: string; payload: string }) {\n  return {\n    ...state,\n    [action.type]: action.payload,\n  };\n}\n\nconst SpeedView: React.FC = () => {\n  const { data } = useApi('serverLocations');\n  const [speed, setSpeed] = useReducer(updateSpeedReducer, {});\n  const [started, setStarted] = useState(false);\n\n  const servers = useMemo(\n    () =>\n      map(data?.items, ({ name, location }) => ({\n        name,\n        location,\n        server: `https://${location}-speed.streambox.in`,\n        dlURL: `/garbage.php`,\n        ulURL: `/empty.php`,\n        pingURL: `/empty.php`,\n        getIpURL: `/getIP.php`,\n      })),\n    [data?.items],\n  );\n  const workers = useMemo(\n    () =>\n      map(servers, (server) => {\n        // @ts-expect-error\n        const worker = new window['Speedtest']();\n\n        worker._settings.test_order = 'IP_D';\n        worker._settings.xhr_dlMultistream = 1;\n\n        worker.setSelectedServer(server);\n\n        worker.onupdate = ({ testState, dlStatus }: { testState: number; dlStatus: string }) => {\n          setSpeed({\n            type: server.location,\n            payload: dlStatus || ((testState === 1 || testState === 2) && 'Начинаем') || '',\n          });\n        };\n\n        return worker;\n      }),\n    [servers, setSpeed],\n  );\n  const [currentWorkerIndex, setCurrentWorkerIndex] = useState(0);\n\n  const handleStart = useCallback(() => {\n    setStarted(true);\n    setCurrentWorkerIndex(0);\n  }, []);\n\n  const handleStop = useCallback(() => {\n    setStarted(false);\n  }, []);\n\n  useEffect(() => {\n    if (workers[currentWorkerIndex]) {\n      if (started) {\n        workers[currentWorkerIndex].onend = () => {\n          setCurrentWorkerIndex(currentWorkerIndex + 1);\n        };\n\n        if (workers[currentWorkerIndex]._state !== 3) {\n          workers[currentWorkerIndex].start();\n        }\n      } else {\n        if (workers[currentWorkerIndex]._state === 3) {\n          workers[currentWorkerIndex].abort();\n        }\n      }\n    } else {\n      handleStop();\n    }\n  }, [started, workers, currentWorkerIndex, handleStop]);\n\n  useEffect(() => {\n    return () => {\n      handleStop();\n    };\n  }, [handleStop]);\n\n  useEffect(() => {\n    const script = document.createElement('script');\n    script.src = './speedtest.js';\n    script.async = true;\n\n    document.head.appendChild(script);\n\n    return () => {\n      document.head.removeChild(script);\n    };\n  }, []);\n\n  return (\n    <>\n      <Text>Проверка скорости</Text>\n\n      <Locations>\n        {map(data?.items, (location) => (\n          <Location key={location.id}>\n            <Text>{location.name}</Text>\n            {speed[location.location] || '0.00'}\n            <Text>Mbit/s</Text>\n          </Location>\n        ))}\n      </Locations>\n\n      <Actions>\n        {started ? (\n          <Button icon=\"stop\" onClick={handleStop}>\n            Стоп\n          </Button>\n        ) : (\n          <Button icon=\"play_arrow\" onClick={handleStart}>\n            Начать\n          </Button>\n        )}\n      </Actions>\n    </>\n  );\n};\n\nexport default SpeedView;\n"],"sourceRoot":""}